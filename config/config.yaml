common:
  log: "./logs/watchdog.log"
  slurm_template: "/path-to-slurm_template"
  # Здесь хранятся пути к файлам, использующимся в ВОТЧДОГЕ в качестве референсных 
  reference_files:
    pore_data: data/pore_data.yaml

# DB INFO
database:
  host: "vu10-2-002"
  name: "nanopore"
  user: "guest"
  password: "guest"
  timeout: "100"
  # Конфиг БД для DAO: коллекции и их индексы.
  # Направления: ASC/DESC. Доп. опции (unique/sparse/partialFilterExpression) — по месту.
  collections:
    files:
      indexes:
        - name: ix_name
          keys: [["name", "ASC"]]
        - name: ix_batch_sample
          keys: [["batch", "ASC"], ["sample", "ASC"]]
        - name: ix_stat_dev_ino
          unique: true
          keys: [["dev", "ASC"], ["ino", "ASC"]]
        - name: ix_fingerprint
          unique: true
          keys: [["fingerprint", "ASC"]]

    batches:
      indexes:
        - name: ix_name
          keys: [["name", "ASC"]]
        - name: ix_curation
          keys: [["needs_curation", "ASC"]]
        - name: ix_status
          keys: [["status", "ASC"]]
        - name: ix_updated_at
          keys: [["updated_at", "DESC"]]
        - name: ix_fingerprint
          unique: true
          keys: [["fingerprint", "ASC"]]

    samples:
      indexes:
        - name: ix_name
          keys: [["name", "ASC"]]
        - name: uq_batches
          keys: [["batches", "ASC"]]
        - name: ix_status
          keys: [["status", "ASC"]]
        - name: ix_curation
          keys: [["needs_curation", "ASC"]]
        - name: ix_updated_at
          keys: [["modified", "DESC"]]
        - name: ix_fingerprint
          unique: true
          keys: [["fingerprint", "ASC"]]

    curations:
      indexes:
        - name: ix_name
          keys: [["name", "ASC"]]
        - name: ix_fingerprint
          unique: true
          keys: [["fingerprint", "ASC"]]

    human:
      indexes:
        - name: ix_sample
          keys: [["sample", "ASC"]]
        - name: ix_created_at
          keys: [["created_at", "DESC"]]

# FILESYSTEM INFO
filesystem:
  source_dir: "/common_share/github/proj_prefect/test/data/raw/"
  # директория для хранения стандартизированных ссылок на файлы
  link_dir: "/common_share/github/proj_prefect/test/data/links/"
  source_files_extensions: "fast5,pod5,fastq.gz"
  # Пауза перед записью в БД в секундах (для исключения множественных обращений к БД)
  db_writing_debounce: 10
  # Время перед регистрацией модификации файла в секундах (для исключения генерации метаданных для файла во время его копирования)
  file_modification_debounce: 5
  # Пауза между проверками на наличие данных для загрузки в БД в секундах
  db_update_interval: 30

# TASK SCHEDULER INFO
scheduler:
  result_dir: "/common_share/github/proj_prefect/test/data/result/"
  processing_dir: "/common_share/github/proj_prefect/test/data/tmp/"
  slurm_user: "kbajbekov"
  slurm_poll_interval: 60
  slurm_queue_size: 32
  slurm_template: "/path-to-slurm_template"

  pipelines:
    # При изменении версии пайплайнов запускается реанализ всего даунстрима
    # В названии раздела указывается название и версия пайплайна
    basecalling_r941_basic_v1.0.0:
      name: basecalling
      version: v1.0.0
      input_data_shaper: data_shaper_ont_basecalling_v1-0-0.py
      output_data_shaper: db_filler_ont_basecalling_v1-0-0.py
      # conditions: прописываются условия, позволяющие исключить как уже обработанные образцы,
      # так и не обработанные образцы, не подходящие по входным параметрам
      conditions:
        - field: status
          type: eq       # Равенство
          value: indexed
      #      - type: ne       # Не равно (поддержка массива)
      #        field: pipeline_basecalling_{{ modifications }}_status
      #        value: ["ok", "fail", "running"]
      #      - type: gte      # Больше или равно
      #        field: total_size
      #        value: 10
      #      - type: exists   # Проверка наличия поля
      #        field: sample_id
      resources:
        reqpartition:
          - gpu_nodes
        time: "3-00:00"
        mem: "640G"
      # Указывается время выполнения пайплайна на стандартном образце. Необходим для корректного формирования очередей
      estimated_time: 2d
      command_template: |
        nextflow \
        -log {{ output_dir }}/logs/nextflow/{{ run_id }}_{{ time_now }}_nxf.log \
        run {{ nextflow_pipelines_dir }}/nxf_ont-basecalling \
        -c {{ pipeline_config }} \
        -name nxf_{{ run_id }} \
        --pore r941 \
        --modifications basic \
        --outdir {{ output_dir }}
      expected_output_files:
        - "*.ubam"
        - "*_sequali.json"
        - "*_sequali.html"
        - "*_multiqc_report.html"
