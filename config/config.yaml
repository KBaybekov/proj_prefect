common:
  log: "./logs/watchdog.log"
  slurm_template: "/path-to-slurm_template"
  # Здесь хранятся пути к файлам, использующимся в ВОТЧДОГЕ в качестве референсных 
  reference_files:
    pore_data: data/pore_data.yaml

# DB INFO
database:
  host: "vu10-2-002"
  name: "nanopore"
  user: "guest"
  password: "guest"
  timeout: "100"
  # Конфиг БД для DAO: коллекции и их индексы.
  # Направления: ASC/DESC. Доп. опции (unique/sparse/partialFilterExpression) — по месту.
  collections:
    files:
      indexes:
        - name: ix_name
          keys: [["name", "ASC"]]
        - name: ix_batch_sample
          keys: [["batch", "ASC"], ["sample", "ASC"]]
        - name: ix_stat_dev_ino
          unique: true
          keys: [["dev", "ASC"], ["ino", "ASC"]]
        - name: ix_fingerprint
          unique: true
          keys: [["fingerprint", "ASC"]]

    batches:
      indexes:
        - name: ix_name
          keys: [["name", "ASC"]]
        - name: ix_curation
          keys: [["needs_curation", "ASC"]]
        - name: ix_status
          keys: [["status", "ASC"]]
        - name: ix_updated_at
          keys: [["updated_at", "DESC"]]
        - name: ix_fingerprint
          unique: true
          keys: [["fingerprint", "ASC"]]

    samples:
      indexes:
        - name: ix_name
          keys: [["name", "ASC"]]
        - name: uq_batches
          keys: [["batches", "ASC"]]
        - name: ix_status
          keys: [["status", "ASC"]]
        - name: ix_curation
          keys: [["needs_curation", "ASC"]]
        - name: ix_updated_at
          keys: [["modified", "DESC"]]
        - name: ix_fingerprint
          unique: true
          keys: [["fingerprint", "ASC"]]

    curations:
      indexes:
        - name: ix_name
          keys: [["name", "ASC"]]
        - name: ix_fingerprint
          unique: true
          keys: [["fingerprint", "ASC"]]

    human:
      indexes:
        - name: ix_sample
          keys: [["sample", "ASC"]]
        - name: ix_created_at
          keys: [["created_at", "DESC"]]

# FILESYSTEM INFO
filesystem:
  source_dir: "/common_share/github/proj_prefect/test/data/raw/"
  # директория для хранения стандартизированных ссылок на файлы
  link_dir: "/common_share/github/proj_prefect/test/data/links/"
  source_files_extensions: "fast5,pod5,fastq.gz"
  # Пауза перед записью в БД в секундах (для исключения множественных обращений к БД)
  db_writing_debounce: 10
  # Время перед регистрацией модификации файла в секундах (для исключения генерации метаданных для файла во время его копирования)
  file_modification_debounce: 5
  # Пауза между проверками на наличие данных для загрузки в БД в секундах
  db_update_interval: 30

# TASK SCHEDULER INFO
scheduler:
  db_poll_interval: 10
  result_dir: "/common_share/github/proj_prefect/test/data/result/"
  processing_dir: "/common_share/github/proj_prefect/test/data/tmp/"
  # Директория с файлами шейперов
  shapers_dir: "/raid/kbajbekov/common_share/github/proj_prefect/data/data_shapers/"
  # Файл конфигурации организации для Nextflow
  nextflow_config: "/path-to-nextflow.config"

# SCHEDULER INFO
slurm:
  slurm:
    user: "kbajbekov"
    poll_interval: 5
    queue_size: 32
    # Узел, на котором будет запущена head-задача
    head_job_node: "vu10-2-027"
    starting_script_template: "/path-to-slurm_template"

  # Вспомогательные файлы, необходимые для пайплайнов
  service_data:
    reference_hg38: "hg38.fa"
    reference_hg38_t2t: "hg38_t2t.fa"

  pipelines:
    # При изменении версии пайплайнов запускается реанализ всего даунстрима
    # В названии раздела указывается название и версия пайплайна
    ont-basecalling_v1-0-0:
      name: ont-basecalling
      version: v1.0.0
      data_shaper: data_shaper_ont-basecalling_v1-0-0.py
      # conditions: прописываются условия, позволяющие исключить как уже обработанные образцы,
      # так и не обработанные образцы, не подходящие по входным параметрам
      conditions:
        - field: status
          type: eq       # Равенство
          value: indexed
        #      - type: ne       # Не равно (поддержка массива)
        #        field: pipeline_basecalling_{{ modifications }}_status
        #        value: ["ok", "fail", "running"]
        #      - type: gte      # Больше или равно
        #        field: total_size
        #        value: 10
        #      - type: exists   # Проверка наличия поля
        #        field: sample_id
      # Тип сортировки и показатель, по которому будет производиться сортировка
      sorting: "SJF,total_input_files_size"
      # Дополнительные параметры SBATCH для запуска головного задания
      # Указываются как параметр: значение
      # sbatch_params:
      #   partition: "gpu"
      # Указывается время выполнения пайплайна на стандартном образце. Необходим для корректного формирования очередей. Формат: DAYS-HH:MM
      timeout: "3-00:00"
      environment_variables:
        GPUS_FOR_BASECALLING: "1"
        GPU_IDS_FOR_BASECALLING: "6"
      # !!! ВНИМАНИЕ !!! При изменении шаблона команды необходимо изменять и соответствующий шейпер
      command_template: |
        nextflow \
        run nxf-csp/ont-basecalling \
        -c {{ NXF_CFG }} \
        -name nxf_{{ JOB_NAME }}_${TIMESTAMP} \
        --input {{ INPUT_SAMPLESHEET }} \
        --sample {{ SAMPLE }} \
        --run_id {{ NXF_RUN_ID }} \
        --outdir {{ OUTPUT_DIR }} \
        -resume
      # словарь вида {тип_файлов: маска}
      output_files_expected:
        ubam: "*.ubam"
        sequali_json: "*_sequali.json"
        sequali_html: "*_sequali.html"
        multiqc_report: "*_multiqc_report.html"

